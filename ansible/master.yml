- hosts: master
  become: yes
  gather_facts: yes

  vars:
    kubeconfig: /etc/kubernetes/admin.conf

  tasks:

  # ==================================================
  # 0. WAIT FOR CLOUD-INIT (CRITICAL)
  # ==================================================
  - name: Wait for cloud-init to finish
    shell: cloud-init status --wait
    changed_when: false

  # ==================================================
  # 1. CHECK IF CLUSTER IS ALREADY INITIALIZED
  # ==================================================
  - name: Check if kube-apiserver manifest exists
    stat:
      path: /etc/kubernetes/manifests/kube-apiserver.yaml
    register: apiserver_manifest

  # ==================================================
  # 2. INITIALIZE KUBERNETES (ONLY ONCE)
  # ==================================================
  - name: Initialize Kubernetes cluster
    command: kubeadm init --pod-network-cidr=10.244.0.0/16
    when: not apiserver_manifest.stat.exists
    register: kubeadm_init
    changed_when: kubeadm_init.rc == 0

  # ==================================================
  # 3. CONFIGURE KUBECTL FOR UBUNTU USER
  # ==================================================
  - name: Ensure kubeconfig directory exists
    file:
      path: /home/ubuntu/.kube
      state: directory
      owner: ubuntu
      group: ubuntu
      mode: '0755'

  - name: Copy admin kubeconfig
    copy:
      src: /etc/kubernetes/admin.conf
      dest: /home/ubuntu/.kube/config
      owner: ubuntu
      group: ubuntu
      mode: '0644'
      remote_src: yes

  # ==================================================
  # 4. WAIT FOR API SERVER
  # ==================================================
  - name: Wait for kube-apiserver to be healthy
    shell: curl -k https://127.0.0.1:6443/healthz
    register: api_health
    retries: 20
    delay: 15
    until: api_health.stdout == "ok"

  - name: Verify kubectl access
    shell: kubectl get nodes
    environment:
      KUBECONFIG: "{{ kubeconfig }}"
    retries: 10
    delay: 10
    register: kubectl_check
    until: kubectl_check.rc == 0

  # ==================================================
  # 5. INSTALL CNI (FLANNEL) â€” MUST BE EARLY
  # ==================================================
  - name: Check if Flannel is already installed
    stat:
      path: /etc/cni/net.d/10-flannel.conflist
    register: flannel_conf

  - name: Install Flannel CNI
    command: kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
    environment:
      KUBECONFIG: "{{ kubeconfig }}"
    when: not flannel_conf.stat.exists

  # ==================================================
  # 6. WAIT FOR NODE & COREDNS
  # ==================================================
  - name: Wait for all nodes to be Ready
    shell: kubectl wait --for=condition=Ready node --all --timeout=5m
    environment:
      KUBECONFIG: "{{ kubeconfig }}"
    changed_when: false

  - name: Wait for CoreDNS to be Available
    shell: kubectl wait --for=condition=Available deployment/coredns -n kube-system --timeout=5m
    environment:
      KUBECONFIG: "{{ kubeconfig }}"
    changed_when: false

  # ==================================================
  # 7. INSTALL HELM
  # ==================================================
  - name: Check if Helm is installed
    stat:
      path: /usr/local/bin/helm
    register: helm_bin

  - name: Install Helm
    shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    when: not helm_bin.stat.exists

  # ==================================================
  # 8. CERT-MANAGER (AFTER DNS & CNI)
  # ==================================================
  - name: Install cert-manager
    become_user: ubuntu
    shell: |
      kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml

  - name: Wait for cert-manager deployments
    become_user: ubuntu
    shell: |
      kubectl rollout status deployment/cert-manager -n cert-manager --timeout=5m
      kubectl rollout status deployment/cert-manager-webhook -n cert-manager --timeout=5m
      kubectl rollout status deployment/cert-manager-cainjector -n cert-manager --timeout=5m

  # ==================================================
  # 9. AWS LOAD BALANCER CONTROLLER
  # ==================================================
  - name: Add EKS Helm repo
    become_user: ubuntu
    shell: |
      helm repo add eks https://aws.github.io/eks-charts
      helm repo update

  - name: Install AWS Load Balancer Controller
    become_user: ubuntu
    shell: |
      helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
        -n kube-system \
        --set clusterName={{ cluster_name }} \
        --set region={{ region }} \
        --set vpcId={{ vpc_id }} \
        --set serviceAccount.create=true \
        --set serviceAccount.name=aws-load-balancer-controller

  - name: Wait for AWS Load Balancer Controller
    become_user: ubuntu
    shell: |
      kubectl rollout status deployment/aws-load-balancer-controller -n kube-system --timeout=5m

  # ==================================================
  # 10. GENERATE JOIN COMMAND (SAFE)
  # ==================================================
  - name: Check if join command already exists
    stat:
      path: /tmp/kubeadm_join.sh
    register: join_script

  - name: Generate join command
    command: kubeadm token create --print-join-command
    register: join_cmd
    when: not join_script.stat.exists

  - name: Save join command
    copy:
      content: "{{ join_cmd.stdout }}"
      dest: /tmp/kubeadm_join.sh
      mode: '0755'
    when: not join_script.stat.exists