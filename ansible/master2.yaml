- hosts: master
  become: yes
  gather_facts: yes

  vars:
    kubeconfig: /etc/kubernetes/admin.conf

  tasks:

  - name: Ensure ubuntu can access kubeconfig
    file:
      path: /etc/kubernetes/admin.conf
      owner: ubuntu
      group: ubuntu
      mode: '0644'

  # ==================================================
  # CLUSTER GUARD (FAIL FAST)
  # ==================================================
  - name: Verify Kubernetes API is reachable
    become_user: ubuntu
    shell: kubectl get nodes
    register: k8s_health
    retries: 10
    delay: 10
    until: k8s_health.rc == 0
    changed_when: false

  # ==================================================
  # CERT-MANAGER (GUARDED)
  # ==================================================

  - name: Check if cert-manager namespace exists
    become_user: ubuntu
    shell: kubectl get ns cert-manager
    register: cert_ns
    failed_when: false
    changed_when: false

  - name: Install cert-manager (only if missing)
    become_user: ubuntu
    shell: |
      kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml
    when: cert_ns.rc != 0

  - name: Check if cert-manager controller is already ready
    become_user: ubuntu
    shell: |
      kubectl get deployment cert-manager -n cert-manager \
      -o jsonpath='{.status.readyReplicas}'
    register: cert_ready
    failed_when: false
    changed_when: false

  - name: Wait for cert-manager deployments
    become_user: ubuntu
    shell: |
      kubectl rollout status deployment/cert-manager -n cert-manager --timeout=5m
      kubectl rollout status deployment/cert-manager-webhook -n cert-manager --timeout=5m
      kubectl rollout status deployment/cert-manager-cainjector -n cert-manager --timeout=5m
    when: cert_ready.stdout | int < 1

  # ==================================================
  # HELM REPO (GUARDED)
  # ==================================================

  - name: Check if EKS Helm repo exists
    become_user: ubuntu
    shell: helm repo list | grep eks
    register: eks_repo
    failed_when: false
    changed_when: false

  - name: Add EKS Helm repo
    become_user: ubuntu
    shell: |
      helm repo add eks https://aws.github.io/eks-charts
      helm repo update
    when: eks_repo.rc != 0

  # ==================================================
  # AWS LOAD BALANCER CONTROLLER (GUARDED)
  # ==================================================

  - name: Check AWS Load Balancer Controller deployment
    become_user: ubuntu
    shell: kubectl get deployment aws-load-balancer-controller -n kube-system
    register: alb_dep
    failed_when: false
    changed_when: false

  - name: Install AWS Load Balancer Controller
    become_user: ubuntu
    shell: |
      helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
        -n kube-system \
        --set clusterName={{ cluster_name }} \
        --set region={{ region }} \
        --set vpcId={{ vpc_id }} \
        --set serviceAccount.create=true \
        --set serviceAccount.name=aws-load-balancer-controller
    when: alb_dep.rc != 0

  - name: Wait for AWS Load Balancer Controller deployment
    become_user: ubuntu
    shell: |
      kubectl rollout status deployment/aws-load-balancer-controller \
        -n kube-system --timeout=5m

  # ==================================================
  # WEBHOOK CERT + TLS (STRONG GUARDS)
  # ==================================================

  - name: Check webhook CA bundle size
    become_user: ubuntu
    shell: |
      kubectl get validatingwebhookconfiguration aws-load-balancer-webhook \
      -o jsonpath='{.webhooks[0].clientConfig.caBundle}' | wc -c
    register: ca_bundle
    failed_when: false
    changed_when: false

  - name: Wait for AWS LB webhook CA bundle injection
    become_user: ubuntu
    shell: |
      kubectl get validatingwebhookconfiguration aws-load-balancer-webhook \
        -o jsonpath='{.webhooks[0].clientConfig.caBundle}' | wc -c
    register: ca_bundle_wait
    retries: 30
    delay: 10
    until: ca_bundle_wait.stdout | int > 100
    when: ca_bundle.stdout | int < 100
    failed_when: false
    changed_when: false

  - name: Check if webhook service exists
    become_user: ubuntu
    shell: kubectl get svc aws-load-balancer-webhook-service -n kube-system
    register: webhook_svc
    failed_when: false
    changed_when: false

  - name: Wait for AWS LB webhook TLS endpoint
    become_user: ubuntu
    shell: |
      kubectl run tmp-webhook-test \
        --rm -i --restart=Never \
        --image=curlimages/curl:8.5.0 \
        -- \
        curl -sk https://aws-load-balancer-webhook-service.kube-system.svc:443/healthz
    register: webhook_test
    retries: 30
    delay: 10
    until: webhook_test.rc == 0
    when: webhook_svc.rc == 0
    failed_when: false
    changed_when: false

  # ==================================================
  # PATCH WORKER NODES WITH PROVIDER ID (AUTOMATED FIX)
  # ==================================================

  # 1. Fetch both Instance ID AND Internal Hostname from workers
  - name: Get AWS Metadata from workers
    delegate_to: "{{ item }}"
    delegate_facts: true
    loop: "{{ groups['workers'] }}"
    shell: |
      echo "$(curl -s http://169.254.169.254/latest/meta-data/instance-id):$(hostname)"
    register: worker_metadata
    changed_when: false

  # 2. Apply the patch using the internal hostname instead of the IP
  - name: Apply providerID patch to Kubernetes nodes
    become_user: ubuntu
    shell: |
      INSTANCE_ID=$(echo "{{ item.stdout }}" | cut -d':' -f1)
      NODE_NAME=$(echo "{{ item.stdout }}" | cut -d':' -f2)
      
      kubectl patch node $NODE_NAME \
      -p "{\"spec\":{\"providerID\":\"aws:///{{ region }}/$INSTANCE_ID\"}}"
    loop: "{{ worker_metadata.results }}"
    when: item.rc == 0
    environment:
      KUBECONFIG: "{{ kubeconfig }}"

  # ==================================================
  # RESTART AWS LOAD BALANCER CONTROLLER (RECONCILE)
  # ==================================================

  - name: Restart AWS Load Balancer Controller
    become_user: ubuntu
    shell: |
      kubectl rollout restart deployment aws-load-balancer-controller -n kube-system
    environment:
      KUBECONFIG: "{{ kubeconfig }}"