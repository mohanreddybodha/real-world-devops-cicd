- hosts: master
  become: yes
  gather_facts: yes

  vars:
    kubeconfig: /etc/kubernetes/admin.conf

  tasks:

  # ==================================================
  # CERT-MANAGER (AFTER DNS & CNI)
  # ==================================================
  - name: Install cert-manager
    become_user: ubuntu
    shell: |
      kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml

  - name: Wait for cert-manager deployments
    become_user: ubuntu
    shell: |
      kubectl rollout status deployment/cert-manager -n cert-manager --timeout=5m
      kubectl rollout status deployment/cert-manager-webhook -n cert-manager --timeout=5m
      kubectl rollout status deployment/cert-manager-cainjector -n cert-manager --timeout=5m

  # ==================================================
  # AWS LOAD BALANCER CONTROLLER
  # ==================================================
  - name: Add EKS Helm repo
    become_user: ubuntu
    shell: |
      helm repo add eks https://aws.github.io/eks-charts
      helm repo update

  - name: Install AWS Load Balancer Controller
    become_user: ubuntu
    shell: |
      helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
        -n kube-system \
        --set clusterName={{ cluster_name }} \
        --set region={{ region }} \
        --set vpcId={{ vpc_id }} \
        --set serviceAccount.create=true \
        --set serviceAccount.name=aws-load-balancer-controller

  - name: Wait for AWS Load Balancer Controller
    become_user: ubuntu
    shell: |
      kubectl rollout status deployment/aws-load-balancer-controller -n kube-system --timeout=5m

  - name: Wait for AWS LB webhook CA bundle injection
    shell: |
      until kubectl get validatingwebhookconfiguration aws-load-balancer-webhook \
        -o jsonpath='{.webhooks[0].clientConfig.caBundle}' | grep -q .; do
        echo "Waiting for AWS LB webhook CA bundle..."
        sleep 10
      done
    changed_when: false
