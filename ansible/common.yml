- hosts: all
  become: yes
  gather_facts: no

  tasks:

    # -----------------------------
    # Swap (Kubernetes requirement)
    # -----------------------------
    - name: Disable swap immediately
      raw: swapoff -a || true

    - name: Disable swap permanently
      raw: sed -i.bak '/ swap /s/^/#/' /etc/fstab

    # -----------------------------
    # Kernel modules (NO copy)
    # -----------------------------
    - name: Configure kernel modules
      raw: |
        mkdir -p /etc/modules-load.d
        cat <<EOF > /etc/modules-load.d/k8s.conf
        overlay
        br_netfilter
        EOF

    - name: Load kernel modules now
      raw: |
        modprobe overlay
        modprobe br_netfilter

    # -----------------------------
    # Sysctl (NO copy)
    # -----------------------------
    - name: Configure sysctl for Kubernetes
      raw: |
        cat <<EOF > /etc/sysctl.d/k8s.conf
        net.bridge.bridge-nf-call-iptables = 1
        net.ipv4.ip_forward = 1
        EOF

    - name: Apply sysctl
      raw: sysctl --system