pipeline {
  agent any

  environment {
    IMAGE_NAME   = "mohanreddybodha/feedback"
    IMAGE_TAG    = "v${BUILD_NUMBER}"
    DOCKER_CREDS = "dockerhub-creds"
    SSH_CREDS    = "ec2-ssh-key"
  }

  options {
    timeout(time: 30, unit: 'MINUTES')
    timestamps()
    disableConcurrentBuilds()   
  }

  stages {

    stage('Checkout Code') {
      steps {
        checkout scm
      }
    }

    stage('Install Dependencies') {
      parallel {
        stage('Backend Deps') {
          steps {
            sh 'cd backend && npm install'
          }
        }
        stage('Frontend Deps') {
          steps {
            sh 'cd frontend && npm install'
          }
        }
      }
    }

    stage('Build Frontend') {
      steps {
        sh '''
          cd frontend
          npm run build || echo "Static app detected"
          mkdir -p ../backend/public
          cp -r dist/* ../backend/public/ || true
        '''
      }
    }

    stage('Test Backend') {
      steps {
        sh 'cd backend && node -c server.js'
      }
    }

    stage('Build & Push Docker Image') {
      steps {
        script {
          docker.withRegistry('https://index.docker.io/v1/', DOCKER_CREDS) {
            sh '''
              docker build -t $IMAGE_NAME:$IMAGE_TAG .
              docker push $IMAGE_NAME:$IMAGE_TAG
            '''
          }
        }
      }
    }

    stage('Terraform Init & Apply') {
      steps {
        dir('terraform') {
          sh '''
            terraform init -input=false
            terraform apply -auto-approve -input=false
          '''
        }
      }
    }
   


    stage('Generate Ansible Inventory') {
      steps {
        script {
          def master_ip = sh(
            script: "cd terraform && terraform output -raw master_ip",
            returnStdout: true
          ).trim()

          def worker_ips = sh(
            script: "cd terraform && terraform output -json worker_ips | jq -r '.[]'",
            returnStdout: true
          ).trim()
          
          def worker_entries = worker_ips
            .split('\n')
            .collect { ip ->
              "${ip} ansible_user=ubuntu ansible_python_interpreter=/usr/bin/python3"
          }
          .join('\n')
          
          writeFile file: "ansible/inventory.ini", text: """
[master]
${master_ip} ansible_user=ubuntu ansible_python_interpreter=/usr/bin/python3


[workers]
${worker_entries}

"""




        }
      }
    }

    stage('Configure Kubernetes Cluster') {
      steps {
        sshagent(credentials: [SSH_CREDS]) {
          dir('ansible') {
            sh '''
              ansible-playbook -i inventory.ini bootstrap.yml
              ansible-playbook -i inventory.ini common.yml
              ansible-playbook -i inventory.ini master.yml
              ansible-playbook -i inventory.ini worker.yml
            '''
          }
        }
      }
    }

    stage('Deploy Application to Kubernetes') {
      steps {
        sshagent(credentials: [SSH_CREDS]) {
          dir('ansible') {
            sh '''
              sed -i "s|{{ IMAGE_NAME }}|${IMAGE_NAME}|g" deploy-app.yml
              sed -i "s|{{ IMAGE_TAG }}|${IMAGE_TAG}|g" deploy-app.yml
              ansible-playbook -i inventory.ini deploy-app.yml
            '''
          }
        }
      }
    }
  }

  post {
    success {
      echo "✅ CI/CD Pipeline completed successfully"
    }
    failure {
      echo "❌ Pipeline failed. Check logs."
    }
  }
}